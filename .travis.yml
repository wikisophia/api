language: go
go:
  - '1.10.7'
  - '1.11.4'
services:
  - postgresql
env:
  global:
    - DEP_VERSION="0.5.0"
    - WKSPH_ARGS_STORAGE_POSTGRES_DBNAME="wikisophia_test"
    - WKSPH_ARGS_STORAGE_POSTGRES_USER="postgres"
before_script:
  - go get -u github.com/golang/lint/golint
  - psql -c 'create database wikisophia_test;' -U postgres
  - psql -c 'create user app_wikisophia;' -U postgres
install:
  - curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
  - dep ensure
script:
  - go test ./...
  - go test ./arguments/postgres -database
    # golint and gofmt always return 0... so they're run twice to make sure their output shows
    # up in the build logs _and_ the build fails if there are issues
  - golint $(go list ./... | grep -v /vendor/)
  - ! [[ $(golint $(go list ./... | grep -v /vendor/)) ]]
  - gofmt -l -s $(ls -d */ | grep -v "vendor") *.go # works around gofmt's lack of support for "./..."
  - ! [[ $(gofmt -l -s $(ls -d */ | grep -v "vendor") *.go) ]]
